/* Base reset */
* { box-sizing: border-box; }

/* Theme Variables */
:root {
    --color-bg: #0f0f10;
    --color-fg: #e6e6e6;
    --color-panel-bg-top: rgba(35,35,40,0.95);
    --color-panel-bg-bottom: rgba(20,20,25,0.95);
    --color-border: #2e2e33;
    --color-key-face1: #3b3e45;
    --color-key-face2: #1d1e22;
    --color-key-press1: #272a30;
    --color-key-press2: #141518;
    --color-key-text: #e2e5ea;
    --color-key-text-pressed: #b9c4d1;
    --color-accent: #3d8bfd;
    --color-spacer: #555;
    --shadow-key-up: 0 3px 0 #121316, 0 2px 10px rgba(0,0,0,0.55);
    --shadow-key-down: 0 1px 0 #121316, 0 1px 4px rgba(0,0,0,0.6);
}


body.theme-light {
    --color-bg: #f4f6fa;
    --color-fg: #1b1f24;
    --color-panel-bg-top: rgba(250,250,252,0.92);
    --color-panel-bg-bottom: rgba(235,237,240,0.92);
    --color-border: #cfd6e0;
    --color-key-face1: #ffffff;
    --color-key-face2: #e5e9ef;
    --color-key-press1: #d4d9e0;
    --color-key-press2: #c2c6cc;
    --color-key-text: #2a2f35;
    --color-key-text-pressed: #555e68;
    --color-spacer: #888;
    --shadow-key-up: 0 3px 0 #b9c0c9, 0 2px 10px rgba(0,0,0,0.15);
    --shadow-key-down: 0 1px 0 #b9c0c9, 0 1px 4px rgba(0,0,0,0.25);
}

body.theme-high-contrast {
    --color-bg: #000;
    --color-fg: #fff;
    --color-panel-bg-top: #000;
    --color-panel-bg-bottom: #000;
    --color-border: #fff;
    --color-key-face1: #000;
    --color-key-face2: #000;
    --color-key-press1: #fff;
    --color-key-press2: #fff;
    --color-key-text: #fff;
    --color-key-text-pressed: #000;
    --color-accent: #fff;
    --color-spacer: #fff;
    --shadow-key-up: 0 0 0 2px #fff;
    --shadow-key-down: 0 0 0 2px #fff inset;
}

body.theme-high-contrast-light {
    --color-bg: #ffffff;
    --color-fg: #000000;
    --color-panel-bg-top: #ffffff;
    --color-panel-bg-bottom: #ffffff;
    --color-border: #000000;
    --color-key-face1: #ffffff;
    --color-key-face2: #ffffff;
    --color-key-press1: #000000;
    --color-key-press2: #000000;
    --color-key-text: #000000;
    --color-key-text-pressed: #ffffff;
    --color-accent: #000000;
    --color-spacer: #000000;
    --shadow-key-up: 0 0 0 2px #000;
    --shadow-key-down: 0 0 0 2px #000 inset;
}

body {
    font-family: system-ui, Arial, sans-serif;
    background: var(--color-bg);
    color: var(--color-fg);
    margin: 0;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    transition: background .35s ease, color .35s ease;
}

/* Braille keyboard container */
#braille-keyboard {
    position: fixed;
    left: 50%;
    bottom: 0;
    transform: translate(-50%, 0);
    display: flex;
    gap: clamp(12px, 2.2vw, 28px);
    padding: 18px 28px 26px;
    background: linear-gradient(180deg, var(--color-panel-bg-top) 0%, var(--color-panel-bg-bottom) 100%);
    backdrop-filter: blur(6px);
    border: 1px solid var(--color-border);
    border-top-left-radius: 22px;
    border-top-right-radius: 22px;
    box-shadow: 0 8px 24px -8px rgba(0,0,0,0.6), 0 2px 4px rgba(255,255,255,0.04) inset;
    z-index: 1000;
    transition: transform .45s cubic-bezier(.4,.0,.2,1), opacity .3s ease;
    will-change: transform;
}

#braille-keyboard[data-hidden="true"] {
    transform: translate(-50%, 110%);
    opacity: 0;
    pointer-events: none;
}

#braille-keyboard .spacer {
    width: clamp(40px, 7vw, 80px);
    height: 1px;
    align-self: center;
    background: radial-gradient(circle at 50% 50%, var(--color-spacer) 0, transparent 70%);
    mask: linear-gradient(90deg, transparent, #000 25%, #000 75%, transparent);
}

.braille-key {
    width: clamp(54px, 7vw, 76px);
    height: clamp(54px, 7vw, 76px);
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, var(--color-key-face1), var(--color-key-face2) 70%);
    border: 1px solid color-mix(in srgb, var(--color-border) 60%, var(--color-bg));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(20px, 3.4vw, 34px);
    font-weight: 500;
    text-transform: lowercase;
    color: var(--color-key-text);
    position: relative;
    cursor: default;
    user-select: none;
    box-shadow: var(--shadow-key-up);
    transition: transform .08s ease, box-shadow .12s ease, background .25s ease;
}

.braille-key::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0));
    pointer-events: none;
    mix-blend-mode: overlay;
}

.braille-key[data-pressed="true"] {
    transform: translateY(4px);
    box-shadow: var(--shadow-key-down);
    background: radial-gradient(circle at 60% 70%, var(--color-key-press1), var(--color-key-press2) 70%);
    border-color: var(--color-key-press1);
    color: var(--color-key-text-pressed);
}

/* Key label modes */
/* Base: show print label by default */
.braille-key .key-print { position: relative; z-index: 1; }
.braille-key .key-braille { display: none; }

body.keymode-braille .braille-key .key-print { display: none; }
body.keymode-braille .braille-key .key-braille { display: inline-block; }

body.keymode-blank .braille-key .key-print,
body.keymode-blank .braille-key .key-braille { visibility: hidden; }

/* Morph mode extends previous animation system */
body.keymode-morph .braille-key {
    overflow: hidden;
}

body.keymode-morph .braille-key .key-print,
body.keymode-morph .braille-key .key-braille {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    transition: transform .35s cubic-bezier(.4,.0,.2,1), opacity .35s ease, filter .35s ease;
    display: inline-block;
    pointer-events: none;
    white-space: nowrap;
}

body.keymode-morph .braille-key .key-braille {
    font-family: "Apple Braille", "SimBraille", ui-monospace, monospace;
    opacity: 0;
    transform: translate(-50%, -30%) scale(.4);
    filter: blur(3px);
}

body.keymode-morph .braille-key[data-pressed="true"] .key-print {
    opacity: 0;
    transform: translate(-50%, 40%) scale(.4);
    filter: blur(4px);
}

body.keymode-morph .braille-key[data-pressed="true"] .key-braille {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    filter: blur(0);
}

@media (prefers-reduced-motion: reduce) {
    body.keymode-morph .braille-key .key-print,
    body.keymode-morph .braille-key .key-braille { transition: none; }
}

/* Space bar pill */
.braille-space {
    flex: 1 1 auto;
    min-width: clamp(140px, 24vw, 300px);
    height: clamp(54px, 7vw, 76px);
    border-radius: 900px;
    background: linear-gradient(145deg, var(--color-key-face1), var(--color-key-face2));
    border: 1px solid color-mix(in srgb, var(--color-border) 60%, var(--color-bg));
    box-shadow: var(--shadow-key-up);
    display: flex;
    align-items: center;
    padding: 0 clamp(14px, 2.2vw, 28px);
    position: relative;
    font-family: inherit;
    color: var(--color-key-text);
    transition: transform .08s ease, box-shadow .12s ease, background .25s ease;
    user-select: none;
    cursor: default;
}

.braille-space[data-pressed="true"] {
    transform: translateY(4px);
    box-shadow: var(--shadow-key-down);
    background: linear-gradient(145deg, var(--color-key-press1), var(--color-key-press2));
    border-color: var(--color-key-press1);
    color: var(--color-key-text-pressed);
}

.braille-space-inner {
    display: flex;
    gap: 12px;
    align-items: center;
    font-size: clamp(14px, 1.5vw, 18px);
    line-height: 1.1;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.braille-cell-label {
    font-family: "Apple Braille", "SimBraille", ui-monospace, monospace;
    font-size: clamp(20px, 2.4vw, 30px);
    letter-spacing: 1px;
    opacity: .65;
}

.braille-cell-ascii {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: clamp(12px, 1.3vw, 16px);
    color: var(--color-key-text);
    opacity: .85;
}

/* New chord display styles */
.braille-symbol {
    font-family: "Apple Braille", "SimBraille", ui-monospace, monospace;
    font-size: clamp(30px, 3vw, 40px);
    line-height: 1;
    display: inline-block;
    min-width: 1em;
    text-align: center;
}

.braille-symbol[data-idle="true"] {
    opacity: 0.25;
    filter: saturate(60%);
}

.braille-letter-desc {
    font-family: system-ui, Arial, sans-serif;
    font-size: clamp(14px, 1.4vw, 18px);
    font-weight: 500;
    letter-spacing: .25px;
    color: var(--color-key-text);
}

/* Space display modes */
body.spacemode-braille .braille-letter-desc { display: none; }

body.spacemode-braille-print .braille-letter-desc { display: inline-block; font-weight: 500; opacity: .85; }

body.spacemode-braille-print-long .braille-letter-desc { display: inline-block; }

body.spacemode-blank .braille-space-inner { visibility: hidden; }

/* Focus ring for accessibility when tabbed */
.braille-key:focus-visible {
    outline: 3px solid var(--color-accent);
    outline-offset: 3px;
}

/* Debug panel overrides (moved inline before, but ensure layering) */
#debug-panel input[type="checkbox"],
#debug-panel select {
    accent-color: var(--color-accent);
}

@media (prefers-reduced-motion: reduce) {
    #braille-keyboard { transition: none; }
    .braille-key { transition: none; }
}

/* Per-key status system */
.braille-key {
    --status-color-info: #2d7dff;
    --status-color-focus: #7e47d6;
    --status-color-success: #2fa764;
    --status-color-warning: #e0a52f;
    --status-color-failure: #e04848;
}

/* New layered status visuals: underlay + amplified outline */
.braille-key .status-underlay {
    position: absolute;
    inset: -32px; /* extend beyond key so only outside glow visible */
    border-radius: 50%;
    pointer-events: none;
    opacity: 0;
    transform: scale(.45);
    transition: opacity .5s cubic-bezier(.22,1.25,.36,1), transform .9s cubic-bezier(.22,1.25,.36,1);
    background: radial-gradient(circle at 50% 55%, transparent 0%, transparent 55%, rgba(255,255,255,0.08) 56%, rgba(255,255,255,0.02) 70%, transparent 85%);
    filter: blur(28px) saturate(160%);
    z-index: 0;
}

/* New layered status visuals: underlay + amplified outline */
.braille-key .status-underlay {
    position: absolute;
    inset: -32px; /* extend beyond key so only outside glow visible */
    border-radius: 50%;
    pointer-events: none;
    opacity: 0;
    transform: scale(.45);
    transition: opacity .5s cubic-bezier(.22,1.25,.36,1), transform .9s cubic-bezier(.22,1.25,.36,1);
    background: radial-gradient(circle at 50% 55%, transparent 0%, transparent 55%, rgba(255,255,255,0.08) 56%, rgba(255,255,255,0.02) 70%, transparent 85%);
    filter: blur(28px) saturate(160%);
    z-index: 0;
}

.braille-key .status-outline {
    position: absolute;
    inset: -26px; /* only outside perimeter */
    border-radius: 50%;
    pointer-events: none;
    opacity: 0;
    transform: scale(.65);
    transition: opacity .45s ease, transform .85s cubic-bezier(.22,1.25,.36,1), filter .6s ease;
    border: 0 solid transparent; /* remove inner border to avoid covering key */
    box-shadow:
        0 0 0 2px rgba(255,255,255,0.12),
        0 0 10px 3px var(--status-outline-color, transparent),
        0 0 30px 14px var(--status-outline-color, transparent),
        0 0 54px 28px var(--status-outline-color, transparent),
        0 0 90px 48px var(--status-outline-color, transparent);
    background: none; /* no overlay on key surface */
    mix-blend-mode: normal;
    z-index: 0; /* behind key */
    filter: saturate(160%) brightness(1.1);
}

.braille-key[data-status] .status-underlay {
    opacity: .85;
    transform: scale(1);
}

.braille-key[data-status] .status-outline {
    opacity: 1;
    transform: scale(1);
    filter: saturate(200%) brightness(1.25);
}

/* Outer severity outline: a crisp edge just beyond the glow */
.braille-key[data-status] .status-outline::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    /* Because the element itself is inset (-26px), this draws a ring outside the physical key */
    box-shadow: 0 0 0 4px var(--status-outline-color), 0 0 14px 6px var(--status-outline-color), 0 0 34px 20px var(--status-outline-color);
    pointer-events: none;
    mix-blend-mode: normal;
    opacity: .95;
}

/* Tight edge outline hugging actual key edge (full opacity) */
.braille-key[data-status]::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    box-shadow: 0 0 0 3px var(--status-outline-color);
    pointer-events: none;
    z-index: 0; /* sits below key gloss (::after) because gloss uses mix-blend overlay */
    opacity: 1;
}

.braille-key[data-status="info"] { --status-outline-color: var(--status-color-info); }
.braille-key[data-status="focus"] { --status-outline-color: var(--status-color-focus); }
.braille-key[data-status="success"] { --status-outline-color: var(--status-color-success); }
.braille-key[data-status="warning"] { --status-outline-color: var(--status-color-warning); }
.braille-key[data-status="failure"] { --status-outline-color: var(--status-color-failure); }

/* Underlay severity tint (radial gradient) */
/* Underlay severity tint now only contributes to outer glow (center kept transparent) */
.braille-key[data-status="info"] .status-underlay { box-shadow: 0 0 34px 12px var(--status-color-info), 0 0 72px 40px color-mix(in srgb, var(--status-color-info) 100%, transparent); }
.braille-key[data-status="focus"] .status-underlay { box-shadow: 0 0 34px 12px var(--status-color-focus), 0 0 72px 40px color-mix(in srgb, var(--status-color-focus) 100%, transparent); }
.braille-key[data-status="success"] .status-underlay { box-shadow: 0 0 34px 12px var(--status-color-success), 0 0 72px 40px color-mix(in srgb, var(--status-color-success) 100%, transparent); }
.braille-key[data-status="warning"] .status-underlay { box-shadow: 0 0 34px 12px var(--status-color-warning), 0 0 72px 40px color-mix(in srgb, var(--status-color-warning) 100%, transparent); }
.braille-key[data-status="failure"] .status-underlay { box-shadow: 0 0 34px 12px var(--status-color-failure), 0 0 72px 40px color-mix(in srgb, var(--status-color-failure) 100%, transparent); }

/* Space bar status ring system (parallels key) */
.braille-space {
    --status-color-info: #2d7dff;
    --status-color-focus: #7e47d6;
    --status-color-success: #2fa764;
    --status-color-warning: #e0a52f;
    --status-color-failure: #e04848;
}

.braille-space .status-underlay {
    position: absolute;
    inset: -20px; /* extend beyond pill */
    border-radius: 1000px;
    pointer-events: none;
    opacity: 0;
    transform: scale(.9);
    transition: opacity .5s cubic-bezier(.22,1.25,.36,1), transform .9s cubic-bezier(.22,1.25,.36,1);
    background: radial-gradient(circle at 50% 55%, transparent 0%, transparent 55%, rgba(255,255,255,0.08) 56%, rgba(255,255,255,0.02) 70%, transparent 85%);
    filter: blur(24px) saturate(160%);
    z-index: 0;
}

.braille-space .status-outline {
    position: absolute;
    inset: -14px;
    border-radius: 1000px;
    pointer-events: none;
    opacity: 0;
    transform: scale(.95);
    transition: opacity .45s ease, transform .85s cubic-bezier(.22,1.25,.36,1), filter .6s ease;
    background: none;
    mix-blend-mode: normal;
    z-index: 0;
    filter: saturate(160%) brightness(1.1);
    box-shadow:
        0 0 0 2px rgba(255,255,255,0.12),
        0 0 10px 3px var(--status-outline-color, transparent),
        0 0 30px 14px var(--status-outline-color, transparent),
        0 0 54px 28px var(--status-outline-color, transparent),
        0 0 90px 48px var(--status-outline-color, transparent);
}

.braille-space[data-status] .status-underlay { opacity: .85; transform: scale(1); }
.braille-space[data-status] .status-outline { opacity: 1; transform: scale(1); filter: saturate(200%) brightness(1.25); }

.braille-space[data-status] .status-outline::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 1000px;
    box-shadow: 0 0 0 3px var(--status-outline-color), 0 0 14px 6px var(--status-outline-color), 0 0 34px 20px var(--status-outline-color);
    pointer-events: none;
    mix-blend-mode: normal;
}

.braille-space[data-status]::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 1000px;
    box-shadow: 0 0 0 3px var(--status-outline-color);
    pointer-events: none;
    z-index: 0;
}

.braille-space[data-status="info"] { --status-outline-color: var(--status-color-info); }
.braille-space[data-status="focus"] { --status-outline-color: var(--status-color-focus); }
.braille-space[data-status="success"] { --status-outline-color: var(--status-color-success); }
.braille-space[data-status="warning"] { --status-outline-color: var(--status-color-warning); }
.braille-space[data-status="failure"] { --status-outline-color: var(--status-color-failure); }

/* Persistent key & space rings (accessible, theme-aware) */
:root {
    --key-ring-bg-dark: #2d3238;
    --key-ring-bg-light: #c5ccd3;
    --key-ring-outline-dark: #59616a;
    --key-ring-outline-light: #6a737b;
}

.braille-key .key-ring {
    position: absolute;
    inset: -18px; /* slightly larger than key */
    border-radius: 50%;
    background: var(--key-ring-bg, var(--key-ring-bg-dark));
    pointer-events: none;
    z-index: -1; /* behind key and status layers */
    box-shadow: 0 4px 14px -6px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.05) inset;
    transition: background .3s ease, box-shadow .3s ease;
    display: none; /* hide base key ring by default */
}

/* Space ring as pill */
.braille-space .space-ring {
    position: absolute;
    inset: -10px;
    border-radius: 1000px;
    background: var(--key-ring-bg, var(--key-ring-bg-dark));
    pointer-events: none;
    z-index: -1;
    box-shadow: 0 4px 16px -6px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.05) inset;
    transition: background .3s ease, box-shadow .3s ease;
    display: none; /* hide space base ring by default */
}

/* Theme overrides */
body.theme-dark .braille-key .key-ring, body.theme-dark .braille-space .space-ring { --key-ring-bg: var(--key-ring-bg-dark); }
body.theme-light .braille-key .key-ring, body.theme-light .braille-space .space-ring { --key-ring-bg: var(--key-ring-bg-light); }

/* High contrast: outline only */
body.theme-high-contrast .braille-key .key-ring, body.theme-high-contrast .braille-space .space-ring,
body.theme-high-contrast-light .braille-key .key-ring, body.theme-high-contrast-light .braille-space .space-ring {
    background: transparent;
    box-shadow: none;
    outline: 3px solid currentColor;
    outline-offset: 0;
}
body.theme-high-contrast .braille-key .key-ring, body.theme-high-contrast .braille-space .space-ring { color: #fff; }
body.theme-high-contrast-light .braille-key .key-ring, body.theme-high-contrast-light .braille-space .space-ring { color: #000; }

/* High contrast overrides: removing blend mode & boosting solid ring */
body.theme-high-contrast .braille-key .status-outline,
body.theme-high-contrast-light .braille-key .status-outline {
    mix-blend-mode: normal;
    box-shadow:
        0 0 0 3px var(--status-outline-color),
        0 0 8px 4px var(--status-outline-color),
        0 0 26px 14px var(--status-outline-color),
        0 0 60px 34px var(--status-outline-color);
    background: none;
}

/* High contrast overrides for space */
body.theme-high-contrast .braille-space .status-outline,
body.theme-high-contrast-light .braille-space .status-outline {
    mix-blend-mode: normal;
    box-shadow:
        0 0 0 3px var(--status-outline-color),
        0 0 8px 4px var(--status-outline-color),
        0 0 26px 14px var(--status-outline-color),
        0 0 60px 34px var(--status-outline-color);
    background: none;
}

body.theme-high-contrast .braille-space .status-underlay,
body.theme-high-contrast-light .braille-space .status-underlay {
    filter: none;
    background: none;
    opacity: .9;
    box-shadow: 0 0 30px 10px var(--status-outline-color), 0 0 70px 40px var(--status-outline-color);
}

body.theme-high-contrast .braille-key .status-underlay,
body.theme-high-contrast-light .braille-key .status-underlay {
    filter: none;
    background: none;
    opacity: .9;
    box-shadow: 0 0 30px 10px var(--status-outline-color), 0 0 70px 40px var(--status-outline-color);
}

@media (prefers-reduced-motion: reduce) {
    .braille-key .status-outline { transition: none; }
}

/* Simplify: disable blurry underlay/outline layers; use crisp ring-only */
.braille-key .status-underlay,
.braille-key .status-outline,
.braille-space .status-underlay,
.braille-space .status-outline {
    display: none !important;
}

/* High-contrast: slightly thicker crisp ring on status */
body.theme-high-contrast .braille-key[data-status]::before,
body.theme-high-contrast-light .braille-key[data-status]::before {
    box-shadow: 0 0 0 4px var(--status-outline-color);
}
body.theme-high-contrast .braille-space[data-status]::before,
body.theme-high-contrast-light .braille-space[data-status]::before {
    box-shadow: 0 0 0 4px var(--status-outline-color);
}

